---
title: "Taking TensorFlow into Production"
subtitle: "(A case study of Zendesk tickets)"
author: "Andrie de Vries<br/>Solutions engineer,RStudio"
date: '2018/09/12 (updated: `r Sys.Date()`)'
output:
  xaringan::moon_reader:
    chakra: libs/remark-latest.min.js
    css:
    - theme/rstudio.css
    - theme/custom.css
    - theme/speech-bubble.css
    lib_dir: libs
    nature:
      countIncrementalSlides: yes
      highlightLines: yes
      highlightStyle: github
      ratio: '4:3'
---
class: rstudio-slide

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
```


---
class: rstudio-slide

# Outline

* Challenges of production deployment

* Model development

* Deployment with RStudio Connect

* Closing the end-to-end loop


.rightbottom[
<img src="images/EARL_logo_dark.png" height=100px />
]


---

class: rstudio-fill-slide, left, middle

# TensorFlow

---
class: rstudio-slide

## TensorFlow


<img src="images/tensors_flowing.gif" style="margin-right: 60px; margin-top: -15px;" align=left />
<img src="images/tensorflow-logo-large.png" width=350; margin-top: -30px;/>

---
class: rstudio-slide

## TensorFlow APIs

<img src="images/tensorflow-apis.png" width=1000/>


---

class: rstudio-fill-slide, left, middle

# Challenges of production deployment

---
class: rstudio-slide

## When production deployment fails

* Failing to quantify the busines value

* Inability to get stakeholder buy-in

* Getting stuck in optimising model fit

* Failing to close the end-to-end loop

* Lack of change management


---
class: rstudio-fill-slide, left, middle

# Problem description: Zendesk tickets

---

class: rstudio-slide

## A typical support ticket


.right-column[
.client-speech[ My code doesn't work, help me ]

.agent-speech[ Sure, what's the problem ]

.client-speech[ I'm stuck... ]

.agent-speech[ . . . ]

.client-speech[ . . . ]
]

--

.left-column[

Initial message

* Subject
* Text
* Company name
* Person
* Date

Subsequently

* tags 
* additional comments


]

---
class: rstudio-slide

## What is a zendesk ticket?

![](images/zendesk-ticket-1.png)

---
class: rstudio-slide

## The business problem

Goal:

* Predict which support tickets will be "complex"
* Complexity is the number of back-and-forth comments in the ticket
* High complexity can also be a leading indicator of troubled accounts

Business value:

* Intervene early in complex tickets
* For example by scheduling a phone call with the customer

---
class: rstudio-slide

## Architecture

![](images/image-01-zendesk-4x3.png)



---
class: rstudio-slide

## Getting stakeholder buy-in

Stakeholder buy-in is critical to the success of your project.

The data science team must work **with** the stakeholders:

* Users
* Management
* IT teams



---
class: rstudio-fill-slide, left, middle

# Machine learning pipeline

---
class: rstudio-slide

## Data warehouse

![](images/image-02-data-warehouse-4x3.png)

---
class: rstudio-slide

## Development environment

![](images/image-03-dev-env-4x3.png)

---
class: rstudio-slide

## Modeling

![](images/training-accuracy.png)


---
class: rstudio-slide

## Don't get stuck in model building

![](images/model-metrics.png)


---

class: rstudio-fill-slide, left, middle

# Deployment with RStudio Connect

---
class: rstudio-slide

## RStudio Connect 

<img src="images/rstudio-connect.png" height=400/>

---
class: rstudio-slide

## Deployment architecture

![](images/image-04-deployment-4x3.png)


---
class: rstudio-slide

## Deploying a TensorFlow model

First deployment

```r

rsconnect::deployTFModel(
  last_model,
  appTitle = glue("TensorFlow classifier {model_name}")
)
```

Subsequent deployments

```r

rsconnect::deployTFModel(
  last_model, 
  appId = "....",
  forceUpdate = TRUE
)
```

---
class: rstudio-slide

## Viewing the TensorFlow model API

In RStudio Connect


![](images/connect-tensorflow-api-cropped.png)

---
class: rstudio-slide

## Calling the TensorFlow serving API

```{r, eval=FALSE}
# Construct the payload
body <- list(
  instances = list(list(
    x_val[1, ]
  )))
```

```{r, eval=FALSE}
# Call the API
api_url <- glue("http://{host}/content/{app_id}/predict")

score <- api_url %>% 
  POST(body = body, encode = "json") %>% 
  content() %>% 
  fromJSON() %>% 
  .$predictions %>% 
  .[, , 1]
```

```{r, eval=FALSE}
score
## [1] 0.486874
```



---
class: rstudio-slide

## plumber APIs

The `plumber` package converts your script into an API using comment decorators

```r
#* @apiTitle TensorFlow zendesk ticket scoring API

#* Predicts ticket complexity given the initial issue.
#*
#* @param org Ticket organization name
#* @param description Ticket description (text)
#* @param title Ticket title
#* @param id Ticket id
#* 
#* @post /
function(id, title, description, org) {
  score <- runif(1) # <<
  record_in_googlesheet(id, title, description, org, score)
  score
}
```

---
class: rstudio-slide

## Hosting plumber APIs on Connect

![](images/connect-api.png)



---

class: rstudio-fill-slide, left, middle

# Closing the end-to-end loop

---
class: rstudio-slide

## Closing the end-to-end loop

* New ticket arrives
* Zendesk triggers a call to `plumber` API
* API
  - pre-processes the text, calls TensorFlow API
  - Retrieves score
  - Write record to log file
  - Calls Zendesk API
* Zendesk
  - Inserts comment into ticket
  - Updates ticket tag

---
class: rstudio-slide

## Updating the ticket information

![](images/zendesk-ticket-2.png)

---
class: rstudio-slide

## Closing the end-to-end loop

![](images/image-05-closed-loop-4x3.png)



---
class: rstudio-slide

## Creating an API log file

![](images/zendesk-ticket-api-log.png)


---

class: rstudio-fill-slide, left, middle

# Summary


---
class: rstudio-slide

## Lessons learnt

It is possible, but harder than it should be.

Feature requests:

* TensorFlow click-button deployment
* Better API swagger documentation
* Sample scripts to generate JSON body

Too early to tell longer term business impact

---
class: rstudio-slide

## What next?

Ideas to improve model

* Different embeddings, e.g. `word2vec`
* Hyperparameter tuning
* Include additional comment text in model

New ideas for business value

* Predict tags based on text
* Predict best support articles
* Automate license key requests


---
class: rstudio-slide

## Overall architecture

![](images/image-06-overall-4x3.png)



---
class: rstudio-slide,  center, middle

# Thank you! 

<img src="images/r-logo.png" width=100/> <img src="images/tensorflow-logo.png" width=100 style="margin-left: 20px; ma"/> 



.smaller[
Slides:

<http://colorado.rstudio.com/rsc/TensorFlow-EARL-2018/>


Subscribe to the blog to stay up to date!


<https://tensorflow.rstudio.com/blog/>
]
